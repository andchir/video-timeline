<div class="flex flex-col h-full bg-[#1e1e1e] text-gray-200 select-none" (mouseup)="onMouseUp()" (mousemove)="onDocumentMouseMove($event)">
  <!-- Toolbar -->
  <div class="flex justify-between items-center px-4 py-3 bg-[#252525] border-b border-[#3a3a3a]">
    <h2 class="text-lg font-semibold m-0">Timeline</h2>
    <div class="flex gap-4 items-center">
      <div class="font-mono text-sm px-3 py-1 bg-[#2a2a2a] rounded">{{ formatTime(state().playheadPosition) }}</div>
    </div>
  </div>

  <!-- Video Preview Area -->
  <div class="flex justify-center items-center py-6 bg-[#252525] border-b border-[#3a3a3a]">
    <div class="flex flex-col items-center gap-3">
      <!-- Video Preview Placeholder -->
      <div class="w-[640px] h-[360px] bg-[#1a1a1a] rounded-lg border border-[#3a3a3a] flex items-center justify-center">
        <div class="flex flex-col items-center gap-2 text-gray-400">
          <i class="bi bi-film text-6xl"></i>
          <span class="text-sm">Предпросмотр видео</span>
        </div>
      </div>

      <!-- Playback Controls -->
      <div class="flex gap-2 items-center">
        <button (click)="skipBackward()" class="px-3 py-2 bg-[#3a3a3a] text-white border-none rounded cursor-pointer text-base transition-colors hover:bg-[#4a4a4a] flex items-center gap-1.5" title="Назад на 5 секунд">
          <i class="bi bi-skip-backward-fill"></i>
          <span class="text-xs">5s</span>
        </button>
        <button (click)="togglePlayback()" class="px-4 py-2 bg-blue-600 text-white border-none rounded cursor-pointer text-xl transition-colors hover:bg-blue-700" [title]="isPlaying() ? 'Пауза' : 'Воспроизведение'">
          @if (isPlaying()) {
            <i class="bi bi-pause-fill"></i>
          } @else {
            <i class="bi bi-play-fill"></i>
          }
        </button>
        <button (click)="skipForward()" class="px-3 py-2 bg-[#3a3a3a] text-white border-none rounded cursor-pointer text-base transition-colors hover:bg-[#4a4a4a] flex items-center gap-1.5" title="Вперёд на 5 секунд">
          <span class="text-xs">5s</span>
          <i class="bi bi-skip-forward-fill"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Timeline content wrapper with unified horizontal scrolling -->
  <div class="flex-1 flex flex-col overflow-y-auto overflow-x-auto relative">
    <!-- Timeline Ruler -->
    <div class="flex border-b border-[#3a3a3a] flex-shrink-0">
      <!-- Control area to align with track headers -->
      <div class="min-w-[150px] bg-[#252525] border-r border-[#3a3a3a] flex justify-center items-center gap-1 p-2">
        <button (click)="addTrack()" class="px-2 py-1 bg-blue-600 text-white border-none rounded cursor-pointer text-sm transition-colors hover:bg-blue-700" title="Добавить трек">
          <i class="bi bi-plus-circle"></i>
        </button>
        <button (click)="zoomOut()" class="px-2 py-1 bg-[#3a3a3a] text-white border-none rounded cursor-pointer text-sm transition-colors hover:bg-[#4a4a4a]" title="Уменьшить масштаб">
          <i class="bi bi-zoom-out"></i>
        </button>
        <button (click)="zoomIn()" class="px-2 py-1 bg-[#3a3a3a] text-white border-none rounded cursor-pointer text-sm transition-colors hover:bg-[#4a4a4a]" title="Увеличить масштаб">
          <i class="bi bi-zoom-in"></i>
        </button>
      </div>
      <!-- Ruler content -->
      <div class="relative h-10 bg-[#2a2a2a] flex-1">
        <div class="relative h-full min-w-full cursor-pointer"
             [style.width.px]="timelineWidth()"
             (mousedown)="onRulerMouseDown($event)">
          @for (marker of getTimeMarkers(); track marker.position) {
            <div class="absolute top-0 h-full" [style.left.px]="marker.position">
              <div class="w-px h-[60%] bg-[#4a4a4a]"></div>
              <div class="text-[10px] text-gray-400 mt-0.5 whitespace-nowrap">{{ marker.label }}</div>
            </div>
          }
        </div>
      </div>
    </div>

    <!-- Tracks -->
    <div class="flex-1">
    @for (track of state().tracks; track track.id) {
      <div class="flex border-b border-[#3a3a3a] min-h-[60px]">
        <!-- Track header -->
        <div class="flex items-center justify-between min-w-[150px] p-2 bg-[#252525] border-r border-[#3a3a3a]">
          <span class="text-sm font-medium">{{ getTrackNumber(track.name) }}</span>
          <div class="flex gap-1">
            <button
              (click)="addMediaItem(MediaType.VIDEO, track.id)"
              class="p-1 text-base text-white border-none bg-transparent cursor-pointer transition-opacity hover:opacity-70"
              title="Добавить видео">
              <i class="bi bi-camera-video"></i>
            </button>
            <button
              (click)="addMediaItem(MediaType.AUDIO, track.id)"
              class="p-1 text-base text-white border-none bg-transparent cursor-pointer transition-opacity hover:opacity-70"
              title="Добавить аудио">
              <i class="bi bi-volume-up"></i>
            </button>
            <button
              (click)="addMediaItem(MediaType.IMAGE, track.id)"
              class="p-1 text-base text-white border-none bg-transparent cursor-pointer transition-opacity hover:opacity-70"
              title="Добавить изображение">
              <i class="bi bi-image"></i>
            </button>
            <button
              (click)="removeTrack(track.id)"
              class="p-1 text-base text-red-500 border-none bg-transparent cursor-pointer transition-opacity hover:opacity-70"
              title="Remove track">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </div>

        <!-- Track timeline -->
        <div class="track relative flex-1 bg-[#1a1a1a] min-h-[60px]"
             [style.width.px]="timelineWidth()"
             (mousemove)="onTrackMouseMove($event, track)">

          @for (item of track.items; track item.id) {
            <div class="media-item group absolute h-12 top-1.5 rounded border-2 border-transparent cursor-move flex items-center overflow-hidden transition-colors hover:border-white/30"
                 [class]="getMediaTypeClass(item.type)"
                 [style.left]="getItemStyle(item).left"
                 [style.width]="getItemStyle(item).width"
                 (mousedown)="onMediaItemMouseDown($event, item, track)">

              <div class="resize-handle resize-handle-left absolute top-0 left-0 w-2 h-full cursor-ew-resize z-10 bg-gradient-to-r from-white/30 to-transparent hover:bg-white/50"></div>

              <div class="flex items-center gap-1.5 px-2 flex-1 overflow-hidden">
                <div class="text-lg flex-shrink-0">
                  @switch (item.type) {
                    @case (MediaType.VIDEO) {
                      <i class="bi bi-camera-video-fill"></i>
                    }
                    @case (MediaType.AUDIO) {
                      <i class="bi bi-volume-up-fill"></i>
                    }
                    @case (MediaType.IMAGE) {
                      <i class="bi bi-image-fill"></i>
                    }
                  }
                </div>
                <div class="flex flex-col overflow-hidden flex-1">
                  <div class="text-[11px] font-medium whitespace-nowrap overflow-hidden text-ellipsis">{{ item.name }}</div>
                  <div class="text-[9px] text-white/60 font-mono">{{ formatTime(item.duration) }}</div>
                </div>
              </div>

              <div class="resize-handle resize-handle-right absolute top-0 right-0 w-2 h-full cursor-ew-resize z-10 bg-gradient-to-l from-white/30 to-transparent hover:bg-white/50"></div>

              <button
                class="media-item-delete absolute top-0.5 right-0.5 w-5 h-5 bg-black/60 text-white border-none rounded-full cursor-pointer text-xs leading-none p-0 hidden items-center justify-center hover:bg-red-600"
                (click)="removeMediaItem(item.id, track.id); $event.stopPropagation()">
                <i class="bi bi-x"></i>
              </button>
            </div>
          }
        </div>
      </div>
    }
    </div>

    <!-- Playhead - positioned absolutely over the entire content area -->
    <div class="absolute top-0 bottom-0 pointer-events-none z-[1000]"
         [style.left.px]="playheadVisualPosition()"
         (mousedown)="onPlayheadMouseDown($event)">
      <div class="absolute top-0 -left-1.5 w-3 h-3 bg-red-500 rounded-sm cursor-ew-resize pointer-events-auto"></div>
      <div class="absolute top-3 left-0 w-0.5 h-full bg-red-500 pointer-events-none"></div>
    </div>
  </div>
</div>
